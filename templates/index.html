<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TileHarvester</title>
    
    <!-- 引入外部库 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- 自定义样式 -->
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        
        #map {
            height: 600px;
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .bbox-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
        }
        
        .download-progress {
            margin-top: 15px;
        }
        
        .map-controls {
            margin-bottom: 15px;
        }
        
        .layer-controls {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">地图瓦片下载器</h1>
        
        <div class="row">
            <!-- 左侧：地图显示 -->
            <div class="col-md-7">
                <!-- 地图绘制控制 -->
                <div class="map-controls">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-primary" id="drawBboxBtn">绘制区域</button>
                        <button type="button" class="btn btn-secondary" id="clearBboxBtn">清除区域</button>
                        <button type="button" class="btn btn-info" id="fitBboxBtn">适配视图</button>
                    </div>
                </div>
                
                <div id="map"></div>
                
                <!-- 左侧统一设置框 -->
                <div class="mt-3 form-section">
                    
                    <!-- 设置边界坐标 -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="m-0">设置边界坐标</h6>
                            <button type="button" id="applyManualBboxBtn" class="btn btn-sm btn-primary">应用边界</button>
                        </div>
                        <div class="row g-1">
                            <div class="col-sm-3">
                                <label for="manualNorth" class="form-label form-label-sm">北</label>
                                <input type="number" class="form-control form-control-sm" id="manualNorth" name="manual_north" step="0.0001" placeholder="24.27" value="90">
                            </div>
                            <div class="col-sm-3">
                                <label for="manualWest" class="form-label form-label-sm">西</label>
                                <input type="number" class="form-control form-control-sm" id="manualWest" name="manual_west" step="0.0001" placeholder="120.6" value="-180">
                            </div>
                            <div class="col-sm-3">
                                <label for="manualSouth" class="form-label form-label-sm">南</label>
                                <input type="number" class="form-control form-control-sm" id="manualSouth" name="manual_south" step="0.0001" placeholder="24.25" value="-90">
                            </div>
                            <div class="col-sm-3">
                                <label for="manualEast" class="form-label form-label-sm">东</label>
                                <input type="number" class="form-control form-control-sm" id="manualEast" name="manual_east" step="0.0001" placeholder="120.63" value="180">
                            </div>
                        </div>
                        <div class="form-text text-xs text-muted mt-1">
                            <strong>有效范围：</strong>纬度 ±85.0511°，经度 ±180°
                        </div>
                    </div>
                    
                    <!-- 统计瓦片数量 -->
                    <div class="mb-3">
                        <h6 class="m-0 mb-2">统计瓦片数量</h6>
                        <div class="d-flex align-items-center justify-content-between p-2 bg-white rounded shadow-sm">
                            <button type="button" id="calculateTilesBtn" class="btn btn-sm btn-primary">统计瓦片数量</button>
                            <span id="tileCountResult" class="text-primary font-weight-bold" style="font-size: 0.9rem;">总计：-</span>
                        </div>
                    </div>
                    
                    <!-- TMS选项 -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="tms" name="tms">
                            <label class="form-check-label">Use TMS tiles convention (Slippy Map by default)</label>
                        </div>
                    </div>
                </div>

                <!-- 当前区域信息 - 隐藏 -->
                <div class="mt-3 p-2 bg-light rounded border" style="padding: 8px !important; display: none;">
                    <h6 class="mb-1" style="font-size: 0.9rem; margin-bottom: 4px !important;">当前区域信息</h6>
                    <div id="tilesInfo" class="d-flex justify-content-between align-items-center" style="display: none; gap: 1rem;">
                        <div style="flex: 1;">
                            <small class="text-muted" style="font-size: 0.8rem;">总瓦片数</small>
                            <div style="font-size: 1rem; margin-top: 2px;"><span id="totalTiles">0</span></div>
                        </div>
                        <div style="flex: 1;">
                            <small class="text-muted" style="font-size: 0.8rem;">缩放级别范围</small>
                            <div style="font-size: 1rem; margin-top: 2px;"><span id="zoomRange">-</span></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧：参数设置 -->
            <div class="col-md-5">
                <div class="form-section">
                    <form id="downloadForm">
                        
                        <div class="mb-3">
                            <label for="providerUrl" class="form-label">瓦片URL</label>
                            <input type="text" class="form-control" id="providerUrl" name="provider_url" 
                                   placeholder="例如：http://ecn.{s}.tiles.virtualearth.net/tiles/a{q}.jpeg?g=1" 
                                   value="http://ecn.{s}.tiles.virtualearth.net/tiles/a{q}.jpeg?g=1" required>
                            <div class="form-text">
                                输入瓦片服务器URL
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="outputPath" class="form-label">输出路径</label>
                            <input type="text" class="form-control" id="outputPath" name="output_path" placeholder="例如：tiles_bing 或 tiles.mbtiles" value="tiles_datasets" required>
                            <div class="form-text">
                                输入瓦片保存目录或MBTiles文件路径(*.mbtiles)
                            </div>
                        </div>
                        
                        <!-- 保存格式 -->
                        <div class="mb-3">
                            <label for="saveFormat" class="form-label">保存格式</label>
                            <select class="form-select" id="saveFormat" name="save_format">
                                <option value="directory" selected>目录结构</option>
                                <option value="mbtiles">MBTiles文件</option>
                            </select>
                            <div class="form-text">
                                选择瓦片保存格式，MBTiles为单个文件格式
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="subdomains" class="form-label">子域名列表</label>
                            <input type="text" class="form-control" id="subdomains" name="subdomains" placeholder="t0,t1,t2,t3" value="t0,t1,t2,t3">
                            <div class="form-text">
                                输入瓦片服务器子域名
                            </div>
                        </div>
                        
                        <!-- 缩放级别 -->
                        <div class="mb-3">
                            <label class="form-label">缩放级别</label>
                            <div class="row">
                                <div class="col">
                                    <input type="number" class="form-control" id="minZoom" name="min_zoom" 
                                           placeholder="最小缩放" min="1" max="23" value="14" required>
                                </div>
                                <div class="col">
                                    <input type="number" class="form-control" id="maxZoom" name="max_zoom" 
                                           placeholder="最大缩放" min="1" max="23" value="14" required>
                                </div>
                            </div>
                            <div class="form-text text-sm text-muted mt-1">
                                <strong>提示：</strong>支持缩放级别1-23
                            </div>
                        </div>
                        
                        <!-- 线程数 -->
                        <div class="mb-3">
                            <label for="threads" class="form-label">下载线程数</label>
                            <input type="number" class="form-control" id="threads" name="threads" 
                                   min="1" max="32" value="4" required>
                        </div>
                        
                        <!-- 瓦片格式 -->
                        <div class="mb-3">
                            <label for="tileFormat" class="form-label">瓦片格式</label>
                            <select class="form-select" id="tileFormat" name="tile_format">
                                <option value="jpg" selected>JPG</option>
                                <option value="png">PNG</option>
                                <option value="jpeg">JPEG</option>
                            </select>
                            <div class="form-text">
                                选择下载瓦片的图片格式
                            </div>
                        </div>

                        <!-- 下载控制按钮 -->
                    <div class="btn-group w-100" id="downloadControls">
                        <button type="submit" class="btn btn-success" id="downloadBtn">开始下载</button>
                        <button type="button" class="btn btn-warning" id="pauseBtn" style="display: none;">暂停下载</button>
                        <button type="button" class="btn btn-info" id="resumeBtn" style="display: none;">继续下载</button>
                        <button type="button" class="btn btn-danger" id="cancelBtn" style="display: none;">取消下载</button>
                    </div>
                    </form>
                    
                    <!-- 下载状态 -->
                    <div class="status-message" id="statusMessage" style="display: none;"></div>
                    
                    <!-- 下载进度 -->
                    <div class="download-progress" id="downloadProgress" style="display: none; margin-top: 0.5rem; padding: 0.5rem 0;">
                        <div class="mb-1"><small class="text-muted">下载进度</small></div>
                        <div class="progress mb-1">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="text-center mt-1 mb-1" id="progressText">0%</div>
                        <div class="d-flex justify-content-between align-items-center text-sm" style="line-height: 1;">
                            <div>
                                <span class="text-muted">已下载：</span>
                                <span id="downloadedCountText">0</span> / <span id="totalCountText">0</span>
                            </div>
                            <div class="text-center">
                                <span class="text-muted">速度：</span>
                                <span id="downloadSpeed">0 KB/s</span>
                            </div>
                            <div class="text-right">
                                <span class="text-muted">预计剩余：</span>
                                <span id="etaTime">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 引入JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 地图初始化
        let map;
        let drawnItems;
        let currentBbox = null;
        let bingLayer;
        
        // 计算QuadKey（用于Bing地图）
        function tileToQuadKey(x, y, zoom) {
            let quadkey = '';
            for (let i = zoom; i > 0; i--) {
                let digit = 0;
                let mask = 1 << (i - 1);
                if ((x & mask) != 0) digit += 1;
                if ((y & mask) != 0) digit += 2;
                quadkey += digit;
            }
            return quadkey;
        }
        
        // 创建自定义Bing图层类
        const BingTileLayer = L.TileLayer.extend({
            getTileUrl: function(coords) {
                try {
                    const zoom = this._getZoomForUrl ? this._getZoomForUrl() : coords.z;
                    const quadkey = tileToQuadKey(coords.x, coords.y, zoom);
                    
                    // 替换URL中的占位符
                    let url = this._url;
                    
                    // 替换子域名占位符{s}
                    if (url.includes('{s}') && this.options.subdomains && this.options.subdomains.length > 0) {
                        const subdomain = this.options.subdomains[(coords.x + coords.y) % this.options.subdomains.length];
                        url = url.replace('{s}', subdomain);
                    }
                    
                    // 替换QuadKey占位符{q}
                    url = url.replace('{q}', quadkey);
                    
                    console.log('Bing地图请求URL:', url);
                    return url;
                } catch (error) {
                    console.error('Bing地图加载错误:', error);
                    return '';
                }
            }
        });
        
        // 初始化地图
        function initMap() {
            // 设置默认视图为全球范围，缩放级别为2
            map = L.map('map').setView([0, 0], 2);
            
            // 初始化绘图控件
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
            
            // 监听绘图事件
            map.on('click', handleMapClick);
            
            // 使用用户提供的Bing地图URL模板，只显示微软资源
            const bingUrlTemplate = 'https://ecn.{s}.tiles.virtualearth.net/tiles/a{q}.jpeg?g=1';
            
            // 创建Bing图层
            bingLayer = new BingTileLayer(bingUrlTemplate, {
                attribution: '&copy; Microsoft Corporation',
                crossOrigin: 'anonymous',
                subdomains: ['t0', 't1', 't2', 't3']
            });
            
            // 添加Bing图层到地图
            bingLayer.addTo(map);
            
            // 显示地图加载成功信息
            showStatus('Bing地图加载成功！', 'success');
        }
        
        // 处理地图点击事件
        function handleMapClick(e) {
            // 这里可以添加点击处理逻辑
        }
        
        // 绘制区域
        document.getElementById('drawBboxBtn').addEventListener('click', function() {
            // 简单实现：点击地图添加点，双击结束绘制区域
            let points = [];
            let tempMarkers = [];
            
            function onMapClick(e) {
                points.push(e.latlng);
                
                // 添加临时标记并保存到数组
                let marker = L.marker(e.latlng).addTo(map);
                tempMarkers.push(marker);
                
                if (points.length >= 2) {
                    // 计算边界框
                    let north = Math.max(points[0].lat, points[1].lat);
                    let south = Math.min(points[0].lat, points[1].lat);
                    let east = Math.max(points[0].lng, points[1].lng);
                    let west = Math.min(points[0].lng, points[1].lng);
                    
                    // 创建边界框
                    let bbox = L.rectangle([[south, west], [north, east]], {
                        color: 'red',
                        weight: 2,
                        fillColor: 'red',
                        fillOpacity: 0.1
                    });
                    
                    // 清除之前的绘制和临时标记
                    drawnItems.clearLayers();
                    tempMarkers.forEach(marker => map.removeLayer(marker));
                    
                    // 添加边界框
                    drawnItems.addLayer(bbox);
                    
                    // 更新边界框信息
                    updateBboxInfo(north, south, west, east);
                    
                    // 更新手动输入框的值
                    updateManualInputFields(north, south, west, east);
                    
                    // 移除事件监听器
                    map.off('click', onMapClick);
                    
                    // 显示成功提示
                    showStatus('区域绘制完成！', 'success');
                }
            }
            
            map.on('click', onMapClick);
            showStatus('请点击地图上的两个点来绘制下载区域（对角线）', 'info');
        });
        
        // 清除区域
        document.getElementById('clearBboxBtn').addEventListener('click', function() {
            // 清除所有绘制的图层
            drawnItems.clearLayers();
            
            // 清除边界框信息
            clearBboxInfo();
            
            // 重置手动输入框
            resetManualInputFields();
            
            // 显示状态
            showStatus('区域已清除', 'info');
        });
        
        // 适配视图
        document.getElementById('fitBboxBtn').addEventListener('click', function() {
            if (drawnItems.getLayers().length > 0) {
                map.fitBounds(drawnItems.getBounds());
                showStatus('视图已适配区域', 'info');
            } else {
                showStatus('没有绘制区域可适配', 'warning');
            }
        });
        
        // 更新边界框信息
        function updateBboxInfo(north, south, west, east) {
            currentBbox = {
                north: north,
                south: south,
                west: west,
                east: east
            };
            
            // 只更新currentBbox变量，不再更新被隐藏的DOM元素
        }
        
        // 清除边界框信息
        function clearBboxInfo() {
            currentBbox = null;
            
            // 只更新currentBbox变量，不再更新被隐藏的DOM元素
        }
        
        // 更新手动输入框的值
        function updateManualInputFields(north, south, west, east) {
            document.getElementById('manualNorth').value = north.toFixed(6);
            document.getElementById('manualSouth').value = south.toFixed(6);
            document.getElementById('manualWest').value = west.toFixed(6);
            document.getElementById('manualEast').value = east.toFixed(6);
        }
        
        // 重置手动输入框
        function resetManualInputFields() {
            document.getElementById('manualNorth').value = '90';
            document.getElementById('manualSouth').value = '-90';
            document.getElementById('manualWest').value = '-180';
            document.getElementById('manualEast').value = '180';
        }
        
        // 显示状态信息
        function showStatus(message, type = 'info') {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.className = `status-message alert alert-${type}`;
            statusMessage.textContent = message;
            statusMessage.style.display = 'block';
            
            // 3秒后自动隐藏
            if (window.statusTimeout) {
                clearTimeout(window.statusTimeout);
            }
            window.statusTimeout = setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 3000);
        }
        
        // 下载表单提交
        document.getElementById('downloadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!currentBbox) {
                showStatus('请先绘制下载区域！', 'danger');
                return;
            }
            
            // 获取表单数据
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            // 添加TMS选项
            data.tms = document.getElementById('tms').checked;
            
            // 添加边界框数据
            data.north = currentBbox.north;
            data.south = currentBbox.south;
            data.west = currentBbox.west;
            data.east = currentBbox.east;
            
            // 处理子域名列表
            data.subdomains = data.subdomains ? data.subdomains.split(',').map(s => s.trim()).filter(s => s) : [];
            
            // 重命名参数：output_path 改为 output_dir
            data.output_dir = data.output_path;
            delete data.output_path;
            
            // 显示加载状态
            const downloadBtn = document.getElementById('downloadBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const resumeBtn = document.getElementById('resumeBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const statusMessage = document.getElementById('statusMessage');
            const downloadProgress = document.getElementById('downloadProgress');
            
            // 显示暂停和取消按钮，隐藏下载按钮
            downloadBtn.style.display = 'none';
            pauseBtn.style.display = 'block';
            resumeBtn.style.display = 'none';
            cancelBtn.style.display = 'block';
            
            statusMessage.className = 'status-message alert alert-info';
            statusMessage.textContent = '正在准备下载...';
            statusMessage.style.display = 'block';
            
            downloadProgress.style.display = 'block';
            
            // 进度相关变量
            let startTime = Date.now();
            let lastDownloaded = 0;
            let lastTotalBytes = 0;
            let lastTime = Date.now();
            let speedHistory = [];
            const MAX_SPEED_HISTORY = 10;
            let isCancelled = false;
            
            // 建立SSE连接，实时接收进度更新
            const eventSource = new EventSource('/api/progress');
            
            // 暂停按钮事件处理
            pauseBtn.addEventListener('click', function() {
                // 发送暂停请求
                fetch('/api/pause-download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showStatus('下载已暂停', 'warning');
                        // 切换按钮状态
                        pauseBtn.style.display = 'none';
                        resumeBtn.style.display = 'block';
                    } else {
                        showStatus('暂停失败: ' + result.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('暂停下载失败:', error);
                    showStatus('暂停下载失败: ' + error.message, 'danger');
                });
            });
            
            // 继续按钮事件处理
            resumeBtn.addEventListener('click', function() {
                // 发送继续请求
                fetch('/api/resume-download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showStatus('下载已恢复', 'info');
                        // 切换按钮状态
                        resumeBtn.style.display = 'none';
                        pauseBtn.style.display = 'block';
                    } else {
                        showStatus('继续失败: ' + result.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('继续下载失败:', error);
                    showStatus('继续下载失败: ' + error.message, 'danger');
                });
            });
            
            // 取消按钮事件处理
            cancelBtn.addEventListener('click', function() {
                // 设置取消标志
                isCancelled = true;
                
                // 发送取消请求
                fetch('/api/cancel-download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP错误！状态码: ${response.status}`);
                    }
                    return response.json();
                })
                .then(result => {
                    if (result.success) {
                        // 计算总下载时间
                        const endTime = Date.now();
                        const totalTime = endTime - startTime;
                        
                        // 格式化总下载时间
                        let timeText;
                        if (totalTime < 1000) {
                            timeText = `${totalTime} 毫秒`;
                        } else if (totalTime < 60000) {
                            timeText = `${(totalTime / 1000).toFixed(1)} 秒`;
                        } else {
                            const minutes = Math.floor(totalTime / 60000);
                            const seconds = ((totalTime % 60000) / 1000).toFixed(1);
                            timeText = `${minutes} 分 ${seconds} 秒`;
                        }
                        
                        if (result.stats) {
                            statusMessage.className = 'status-message alert alert-warning';
                            statusMessage.innerHTML = `
                                <h6>下载已取消！</h6>
                                <p>已下载：${result.stats.downloaded}</p>
                                <p>失败：${result.stats.failed}</p>
                                <p>跳过：${result.stats.skipped}</p>
                                <p>总计：${result.stats.total}</p>
                                <p>剩余：${result.stats.remaining}</p>
                                <p>用时：${timeText}</p>
                            `;
                            statusMessage.style.display = 'block';
                            // 清除可能存在的自动隐藏计时器
                            if (window.statusTimeout) {
                                clearTimeout(window.statusTimeout);
                            }
                        } else {
                            showStatus('下载已取消', 'warning');
                        }
                    } else if (result.message !== '没有正在进行的下载任务') {
                        // 只显示非"没有正在进行的下载任务"的错误信息
                        showStatus('取消失败: ' + result.message, 'danger');
                    }
                    
                    // 无论成功还是失败，都恢复按钮状态
                    downloadBtn.style.display = 'block';
                    pauseBtn.style.display = 'none';
                    resumeBtn.style.display = 'none';
                    cancelBtn.style.display = 'none';
                    
                    // 关闭SSE连接
                    eventSource.close();
                })
                .catch(error => {
                    console.error('取消下载失败:', error);
                    showStatus('取消下载失败: ' + error.message, 'danger');
                    
                    // 即使发生错误，也恢复按钮状态
                    downloadBtn.style.display = 'block';
                    pauseBtn.style.display = 'none';
                    resumeBtn.style.display = 'none';
                    cancelBtn.style.display = 'none';
                    
                    // 关闭SSE连接
                    eventSource.close();
                });
            });
            
            // 监听进度事件
            eventSource.onmessage = function(event) {
                try {
                    const progressData = JSON.parse(event.data);
                    const { downloaded, total, total_bytes = 0, percentage, completed, stats } = progressData;
                    
                    // 更新右侧进度条
                    const progressBar = downloadProgress.querySelector('.progress-bar');
                    progressBar.style.width = `${percentage}%`;
                    progressBar.setAttribute('aria-valuenow', percentage);
                    document.getElementById('progressText').textContent = `${percentage}%`;
                    document.getElementById('downloadedCountText').textContent = downloaded;
                    document.getElementById('totalCountText').textContent = total;
                    
                    // 移除了左侧进度条，只保留右侧进度显示
                    
                    // 计算下载速度
                    const currentTime = Date.now();
                    const timeDiff = currentTime - lastTime;
                    const downloadDiff = downloaded - lastDownloaded;
                    const bytesDiff = Math.max(0, total_bytes - lastTotalBytes); // 确保字节差不为负
                    
                    // 使用实际下载的字节数来计算速度，而不是瓦片数量
                    if (timeDiff > 0) {
                        // 计算当前速度（KB/s），确保速度不为负
                        const speed = Math.max(0, (bytesDiff * 1000 / timeDiff) / 1024);
                        speedHistory.push(speed);
                        
                        // 限制历史记录长度
                        if (speedHistory.length > MAX_SPEED_HISTORY) {
                            speedHistory.shift();
                        }
                        
                        // 计算平均速度，确保平均速度不为负
                        const avgSpeed = Math.max(0, speedHistory.reduce((sum, s) => sum + s, 0) / speedHistory.length);
                        
                        // 格式化速度显示
                        let speedText;
                        if (avgSpeed < 1024) {
                            speedText = `${avgSpeed.toFixed(1)} KB/s`;
                        } else {
                            speedText = `${(avgSpeed / 1024).toFixed(1)} MB/s`;
                        }
                        document.getElementById('downloadSpeed').textContent = speedText;
                        
                        // 计算剩余时间
                        const remaining = total - downloaded;
                        if (remaining > 0 && avgSpeed > 0) {
                            // 估算剩余字节数：假设每个瓦片平均大小
                            const avgBytesPerTile = total_bytes / (downloaded || 1);
                            const remainingBytes = remaining * avgBytesPerTile;
                            const remainingTime = remainingBytes / (avgSpeed * 1024);
                            
                            // 格式化剩余时间
                            let etaText;
                            if (remainingTime < 60) {
                                etaText = `${Math.ceil(remainingTime)} 秒`;
                            } else if (remainingTime < 3600) {
                                const minutes = Math.floor(remainingTime / 60);
                                const seconds = Math.ceil(remainingTime % 60);
                                etaText = `${minutes} 分 ${seconds} 秒`;
                            } else {
                                const hours = Math.floor(remainingTime / 3600);
                                const minutes = Math.ceil((remainingTime % 3600) / 60);
                                etaText = `${hours} 小时 ${minutes} 分`;
                            }
                            document.getElementById('etaTime').textContent = etaText;
                        } else {
                            document.getElementById('etaTime').textContent = '-';
                        }
                        
                        // 更新最后状态
                        lastDownloaded = downloaded;
                        lastTotalBytes = total_bytes;
                        lastTime = currentTime;
                    }
                    
                    // 更新状态信息
                    if (completed) {
                        // 如果已经取消下载，忽略完成事件
                        if (isCancelled) {
                            eventSource.close();
                            return;
                        }
                        
                        // 下载完成
                        eventSource.close();
                        
                        // 计算总下载时间
                        const endTime = Date.now();
                        const totalTime = endTime - startTime;
                        
                        // 格式化总下载时间
                        let timeText;
                        if (totalTime < 1000) {
                            timeText = `${totalTime} 毫秒`;
                        } else if (totalTime < 60000) {
                            timeText = `${(totalTime / 1000).toFixed(1)} 秒`;
                        } else {
                            const minutes = Math.floor(totalTime / 60000);
                            const seconds = ((totalTime % 60000) / 1000).toFixed(1);
                            timeText = `${minutes} 分 ${seconds} 秒`;
                        }
                        
                        if (stats) {
                            statusMessage.className = 'status-message alert alert-success';
                            statusMessage.innerHTML = `
                                <h6>下载成功！</h6>
                                <p>下载数量：${stats.downloaded}</p>
                                <p>失败数量：${stats.failed}</p>
                                <p>跳过数量：${stats.skipped}</p>
                                <p>总计数量：${stats.total}</p>
                                <p>总计时间：${timeText}</p>
                            `;
                            statusMessage.style.display = 'block';
                        } else {
                            statusMessage.className = 'status-message alert alert-success';
                            statusMessage.innerHTML = `
                                <h6>下载成功！</h6>
                                <p>下载数量：${downloaded}</p>
                                <p>总计数量：${total}</p>
                                <p>总计时间：${timeText}</p>
                            `;
                            statusMessage.style.display = 'block';
                        }
                        
                        // 停止进度条动画
                        const progressBar = downloadProgress.querySelector('.progress-bar');
                        progressBar.classList.remove('progress-bar-animated');
                        
                        // 恢复按钮状态
                        downloadBtn.style.display = 'block';
                        pauseBtn.style.display = 'none';
                        resumeBtn.style.display = 'none';
                        cancelBtn.style.display = 'none';
                    } else {
                        // 正在下载
                        statusMessage.textContent = `正在下载... ${downloaded}/${total} (${percentage}%)`;
                    }
                } catch (error) {
                    console.error('处理进度数据失败:', error);
                }
            };
            
            // 处理SSE错误
            eventSource.onerror = function(error) {
                console.error('SSE连接错误:', error);
                eventSource.close();
            };
            
            // 发送下载请求
            fetch('/api/download', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP错误！状态码: ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                if (!result.success) {
                    // 如果初始请求失败，关闭SSE连接
                    eventSource.close();
                    statusMessage.className = 'status-message alert alert-danger';
                    statusMessage.textContent = `下载失败：${result.error}`;
                    
                    // 恢复按钮状态
                    downloadBtn.style.display = 'block';
                    pauseBtn.style.display = 'none';
                    resumeBtn.style.display = 'none';
                    cancelBtn.style.display = 'none';
                }
            })
            .catch(error => {
                // 关闭SSE连接
                eventSource.close();
                
                statusMessage.className = 'status-message alert alert-danger';
                statusMessage.textContent = `请求失败：${error.message}`;
                console.error('下载请求错误:', error);
                
                // 恢复按钮状态
                downloadBtn.style.display = 'block';
                pauseBtn.style.display = 'none';
                resumeBtn.style.display = 'none';
                cancelBtn.style.display = 'none';
            });
        });
        
        // 计算瓦片数量
        function calculateTilesCount() {
            // 直接从currentBbox变量获取边界坐标，而不是从DOM元素
            if (!currentBbox) {
                showStatus('请先绘制或设置边界坐标！', 'danger');
                return;
            }
            
            const { north, south, west, east } = currentBbox;
            
            // 获取缩放级别
            const minZoom = parseInt(document.getElementById('minZoom').value);
            const maxZoom = parseInt(document.getElementById('maxZoom').value);
            
            // 验证缩放级别
            if (isNaN(minZoom) || isNaN(maxZoom) || minZoom > maxZoom) {
                showStatus('请设置有效的缩放级别范围！', 'danger');
                return;
            }
            
            // 墨卡托投影有效纬度范围：约±85.0511度
            const max_valid_lat = 85.0511;
            const min_valid_lat = -85.0511;
            
            // 限制经纬度在有效范围内
            const valid_north = Math.min(Math.max(north, min_valid_lat), max_valid_lat);
            const valid_south = Math.min(Math.max(south, min_valid_lat), max_valid_lat);
            const valid_west = Math.min(Math.max(west, -180), 180);
            const valid_east = Math.min(Math.max(east, -180), 180);
            
            // 计算每个缩放级别的瓦片数量
            let totalTiles = 0;
            for (let zoom = minZoom; zoom <= maxZoom; zoom++) {
                // 计算瓦片坐标范围，与后端保持一致
                const n = Math.pow(2, zoom);
                
                try {
                    // 左上角瓦片坐标（向下取整）
                    const min_x = Math.floor((valid_west + 180.0) / 360.0 * n);
                    const tan_north = Math.tan(valid_north * Math.PI / 180);
                    const cos_north = Math.cos(valid_north * Math.PI / 180);
                    const min_y = Math.floor((1.0 - Math.log(tan_north + 1.0 / cos_north) / Math.PI) / 2.0 * n);
                    
                    // 右下角瓦片坐标（向上取整，使用1e-10避免浮点精度问题）
                    const max_x = Math.ceil(((valid_east + 180.0) / 360.0 * n) - 1e-10);
                    const tan_south = Math.tan(valid_south * Math.PI / 180);
                    const cos_south = Math.cos(valid_south * Math.PI / 180);
                    const max_y = Math.ceil(((1.0 - Math.log(tan_south + 1.0 / cos_south) / Math.PI) / 2.0 * n) - 1e-10);
                    
                    // 纠正顺序，保证 min <= max
                    let corrected_min_x = Math.min(min_x, max_x);
                    let corrected_max_x = Math.max(min_x, max_x);
                    let corrected_min_y = Math.min(min_y, max_y);
                    let corrected_max_y = Math.max(min_y, max_y);
                    
                    // 限制瓦片坐标在有效范围内（每个缩放级别瓦片坐标范围是0到n-1）
                    const max_tile_coord = n - 1;
                    corrected_min_x = Math.max(0, corrected_min_x);
                    corrected_max_x = Math.min(max_tile_coord, corrected_max_x);
                    corrected_min_y = Math.max(0, corrected_min_y);
                    corrected_max_y = Math.min(max_tile_coord, corrected_max_y);
                    
                    // 计算当前缩放级别的瓦片数量
                    const tilesAtZoom = (corrected_max_x - corrected_min_x + 1) * (corrected_max_y - corrected_min_y + 1);
                    totalTiles += tilesAtZoom;
                } catch (error) {
                    console.error('瓦片计算错误:', error);
                    showStatus('瓦片计算错误: 请检查经纬度范围是否有效', 'danger');
                    return;
                }
            }
            
            // 在按钮旁边显示统计结果
            const tileCountResult = document.getElementById('tileCountResult');
            tileCountResult.textContent = `总计：${totalTiles} 个瓦片`;
            tileCountResult.className = 'text-primary font-weight-bold';
            
            // 显示成功提示
            showStatus(`瓦片数量统计完成，总计 ${totalTiles} 个瓦片！`, 'success');
        }
        
        // 应用手动设置的边界坐标
        document.getElementById('applyManualBboxBtn').addEventListener('click', function() {
            // 获取手动输入的边界坐标
            const manualNorth = parseFloat(document.getElementById('manualNorth').value);
            const manualSouth = parseFloat(document.getElementById('manualSouth').value);
            const manualWest = parseFloat(document.getElementById('manualWest').value);
            const manualEast = parseFloat(document.getElementById('manualEast').value);
            
            // 验证输入
            if (isNaN(manualNorth) || isNaN(manualSouth) || isNaN(manualWest) || isNaN(manualEast)) {
                showStatus('请填写完整的边界坐标！', 'danger');
                return;
            }
            
            if (manualNorth <= manualSouth) {
                showStatus('北坐标必须大于南坐标！', 'danger');
                return;
            }
            
            if (manualEast <= manualWest) {
                showStatus('东坐标必须大于西坐标！', 'danger');
                return;
            }
            
            // 清除之前的绘制
            drawnItems.clearLayers();
            
            // 创建边界框 - 使用红色边框
            const bbox = L.rectangle([[manualSouth, manualWest], [manualNorth, manualEast]], {
                color: 'red',
                weight: 2,
                fillColor: 'red',
                fillOpacity: 0.1
            });
            
            // 添加边界框到地图
            drawnItems.addLayer(bbox);
            
            // 更新边界框信息
            updateBboxInfo(manualNorth, manualSouth, manualWest, manualEast);
            
            // 适配视图
            map.fitBounds(bbox.getBounds());
            
            // 显示成功提示
            showStatus('边界坐标已应用！', 'success');
        });
        
        // 计算瓦片数量按钮事件
        document.getElementById('calculateTilesBtn').addEventListener('click', calculateTilesCount);
        
        // 页面加载完成后初始化地图
        window.addEventListener('load', function() {
            try {
                initMap();
                showStatus('地图加载成功！', 'success');
            } catch (error) {
                console.error('地图初始化错误:', error);
                showStatus('地图加载失败，请检查网络连接或刷新页面', 'danger');
            }
        });
    </script>
</body>
</html>